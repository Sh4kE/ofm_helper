{% extends "core/base.html" %}

{% block content %}
    {% load staticfiles %}

    <h1 class="page-header">
        Transfers
    </h1>

    <div class="transfer-detail">
        <div class="row">
            <div class="col-md-2">
                <label for="TransferGroupByFilter">Gruppieren nach</label>
                <select id="TransferGroupByFilter" data-placeholder="Gruppieren nach" class="selectpicker">
                    <option value="Strength" selected>Stärke</option>
                    <option value="Age">Alter</option>
                    <option value="Position">Position</option>
                    <option value="Season">Saison</option>
                    <option value="Matchday">Spieltag</option>
                </select>
            </div>

            <div class="col-md-2">
                <label for="TransferPositionsFilter"><span class="flaticon-football-list-and-field-outline"></span> Positionen</label>
                <select id="TransferPositionsFilter" class="transfer-filter selectpicker" data-placeholder="Positionen" multiple>
                    <option value="TW">TW</option>
                    <option value="LIB">LIB</option>
                    <option value="LV">LV</option>
                    <option value="LMD">LMD</option>
                    <option value="RMD">RMD</option>
                    <option value="RV">RV</option>
                    <option value="VS">VS</option>
                    <option value="LM">LM</option>
                    <option value="DM">DM</option>
                    <option value="ZM">ZM</option>
                    <option value="RM">RM</option>
                    <option value="LS">LS</option>
                    <option value="MS">MS</option>
                    <option value="RS">RS</option>
                </select>
            </div>

            <div class="col-md-2">
                <label for="TransferAgesFilter"><span class="glyphicon glyphicon-gift"></span> Alter</label>
                <select id="TransferAgesFilter" class="transfer-filter selectpicker" data-placeholder="Alter" multiple>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                    <option value="29">29</option>
                    <option value="30">30</option>
                    <option value="31">31</option>
                    <option value="32">32</option>
                    <option value="33">33</option>
                    <option value="34">34</option>
                    <option value="35">35</option>
                    <option value="36">36</option>
                </select>
            </div>

            <div class="col-md-2">
                <label for="TransferStrengthsFilter"><span class="flaticon-flaming-football"></span> Stärke</label>
                <select id="TransferStrengthsFilter" class="transfer-filter selectpicker" data-placeholder="Stärke" multiple>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                    <option value="29">29</option>
                    <option value="30">30</option>
                </select>
            </div>

            <div class="col-md-2">
                <label for="TransferSeasonsFilter"><span class="glyphicon glyphicon-calendar"></span> Saison</label>
                <select id="TransferSeasonsFilter" class="transfer-filter selectpicker" data-placeholder="Saison" multiple>
                </select>
            </div>

            <div class="col-md-2">
                <label for="TransferMatchdaysFilter"><span class="glyphicon glyphicon-calendar"></span> Spieltag</label>
                <select id="TransferMatchdaysFilter" class="transfer-filter selectpicker" data-placeholder="Spieltag" multiple>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                    <option value="29">29</option>
                    <option value="30">30</option>
                    <option value="31">31</option>
                    <option value="32">32</option>
                    <option value="33">33</option>
                    <option value="34">34</option>
                </select>
            </div>
        </div>
    </div>

    <br>

    <button id="TransferFilterButton" class='btn btn-default'>
        <span class="glyphicon glyphicon-refresh"></span> Filter anwenden
    </button>

    <button id="TransferResetButton" class='btn btn-default'>
        <span class="glyphicon glyphicon-repeat"></span> zurücksetzen
    </button>

    <br>
    <br>

    <div id="transfers_chart_container"></div>

    <br>

    <div class="row">
        <div class="col-md-12">
            <label for="TransferOverviewGroupByFilter">Gruppieren nach</label>
            <select id="TransferOverviewGroupByFilter" data-placeholder="Gruppieren nach" class="selectpicker" multiple>
                <option value="Strength" selected>Stärke</option>
                <option value="Age" selected>Alter</option>
                <option value="Position">Position</option>
                <option value="Season">Saison</option>
                <option value="Matchday">Spieltag</option>
            </select>
        </div>
    </div>

    <br>

    <table id="TransfersOverviewTable" class="table table-striped table-bordered table-hover">
        <tr>
            <th></th>
            <th>29</th>
            <th>30</th>
            <th>31</th>
        </tr>
        <tr>
            <th>10</th>
            <td>6</td>
            <td>5</td>
            <td>4</td>
        </tr>
        <tr>
            <th>11</th>
            <td>11</td>
            <td>10</td>
            <td>9</td>
        </tr>
    </table>

    <script>
        var detail_groupby = 'Strength';
        var overview_groupby = 'Strength,Age';
        var strengths = '';
        var positions = '';
        var ages = '';
        var seasons = '';
        var matchdays = '';

        function resetFilterValues(){
            detail_groupby = 'Strength';
            overview_groupby = 'Strength,Age';
            strengths = '';
            positions = '';
            ages = '';
            seasons = '';
            matchdays = '';
        }

        resetFilterValues();

        $('.transfer-detail .selectpicker').selectpicker({
            actionsBox: true,
            selectAllText: 'Alle auswählen',
            deselectAllText: 'Alle abwählen',
            noneSelectedText: 'Alle'
        });

        $('#TransferOverviewGroupByFilter').selectpicker({
            //actionsBox: true,
            //selectAllText: 'Alle auswählen',
            //deselectAllText: 'Alle abwählen',
            noneSelectedText: 'Foobar',
            maxOptions: 2
        });


        var transfers_chart_options =  {
            chart: {
                type: 'boxplot',
                height: 650,
                zoomType: 'xy',
                panKey: 'ctrl',
                panning: true
            },
            title: {
                text: 'Spielerpreise'
            },
            xAxis: {
                categories: [], // has to be overwritten
                title: {
                    text: 'Stärke'
                }
            },
            yAxis: {
                title: {
                    text: 'Preis'
                }
            },
            plotOptions: {
                boxplot: {
                    fillColor: '#F0F0E0',
                    lineWidth: 1.5,
                    medianColor: '#24a52f',
                    medianWidth: 2,
                    stemWidth: 2,
                    whiskerColor: '#24a52f',
                    whiskerLength: '40%'
                }
            },
            series: [] // has to be overwritten
        };

        function fillFilterDropdown(filter_id, attribute) {
            $('#' + filter_id).html('');

            attribute.forEach(function(item) {
                $('#' + filter_id).append("<option value='" + item + "'>" + item + "</option>");
            });
        }

        function requestChartDetailData() {
            $.ajax({
                type: "GET",
                url: "{% url 'core:ofm:transfers_chart_json' %}",
                data: {
                    group_by: detail_groupby,
                    positions: positions,
                    strengths: strengths,
                    ages: ages,
                    seasons: seasons,
                    matchdays: matchdays
                },
                dataType: 'json',
                success: function (data) {
                    transfers_chart_options.series = data['series'];
                    transfers_chart_options.xAxis.categories = data['categories'];
                    $('#transfers_chart_container').highcharts(transfers_chart_options);

                    // var filters = ['ages', 'strengths', 'positions', 'seasons', 'matchdays'];

                    // filters.forEach(function(filter) {
                    //     var filter_id = 'Transfer' + filter[0].toUpperCase() + filter.substring(1) + 'Filter';
                    // });
                }
            });
        }

        function fillOverviewTable(data){
            $('#TransfersOverviewTable').html('');

            var header_row = '<tr><th></th>';

            var strengthsLength = data.strengths.length;
            for (var i = 0; i < strengthsLength; i++) {
                header_row += '<th>' + data.strengths[i] + '</th>'
            }
            header_row += '</tr>';

            $('#TransfersOverviewTable').append(header_row);

            var agesLength = data.ages.length;
            for (var i = 0; i < agesLength; i++) {
                var row = '<tr><th>' + data.ages[i] + '</th>';

                var rowLength = data.medians[i].length;
                for (var j = 0; j < rowLength; j++) {
                    row += '<td>' + data.medians[i][j] + '</td>';
                }

                row += '</tr>'
                $('#TransfersOverviewTable').append(row);
            }
        }

        function requestChartOverviewData() {
            $.ajax({
                type: "GET",
                url: "{% url 'core:ofm:transfers_overview_chart_json' %}",
                data: {
                    group_by: overview_groupby,
                    positions: positions,
                    strengths: strengths,
                    ages: ages,
                    seasons: seasons,
                    matchdays: matchdays
                },
                dataType: 'json',
                success: function (data) {
                    fillOverviewTable(data);
                }
            });
        }

        $('#TransferGroupByFilter').change(function () {
            detail_groupby = $(this).val();
        });

        $('#TransferPositionsFilter').change(function () {
            if ($(this).val()) {
                positions = $(this).val().join(",");
            } else {
                positions = ''
            }
        });

        $('#TransferAgesFilter').change(function () {
            if ($(this).val()) {
                ages = $(this).val().join(",");
            } else {
                ages = ''
            }
        });

        $('#TransferStrengthsFilter').change(function () {
            if ($(this).val()) {
                strengths = $(this).val().join(",");
            } else {
                strengths = ''
            }
        });

        $('#TransferSeasonsFilter').change(function () {
            if ($(this).val()) {
                seasons = $(this).val().join(",");
            } else {
                seasons = ''
            }
        });

        $('#TransferMatchdaysFilter').change(function () {
            if ($(this).val()) {
                matchdays = $(this).val().join(",");
            } else {
                matchdays = ''
            }
        });

        $('#TransferFilterButton').click(function(){
            requestChartDetailData();
            requestChartOverviewData();
        });

        $('#TransferResetButton').click(function(){
            resetFilterValues();
            requestChartDetailData();
            requestChartOverviewData();
        });

        $(document).ready(function() {
            requestChartDetailData();
            requestChartOverviewData();
        });
    </script>
{% endblock %}
